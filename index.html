<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Daraxt ma’lumotini topish</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <main class="page">
    <section class="card" aria-label="Daraxtni aniqlash sahifasi">
      <div class="topbar" aria-hidden="true"></div>

      <header class="header">
        <img class="logo" src="ecology.png" alt="Logo" />
      </header>

      <div class="content">
        <h1 class="title">Daraxt ma’lumotini topish</h1>
        <p class="subtitle">
          Daraxt ID raqamini kiriting. Tugmani bosing yoki Enter qiling — daraxt sahifasi ochiladi.
        </p>

        <form id="treeForm" class="form" novalidate>
          <div class="field">
            <div class="label">ID raqamini kiriting</div>

            <input
              id="treeId"
              class="input"
              type="text"
              inputmode="numeric"
              autocomplete="off"
              maxlength="20"
              placeholder="Masalan: 12345"
              aria-describedby="errorText"
            />

            <div id="errorText" class="error" role="alert" aria-live="polite"></div>
          </div>

          <button id="submitBtn" class="btn" type="submit">
            Daraxtni aniqlash
          </button>
        </form>

        <footer class="footer">
          © Ekologiya vazirligi • Yo‘naltirish: Yashil makon tizimi
        </footer>
      </div>
    </section>
  </main>

  <!-- app.js (agar bor bo‘lsa ishlaydi) -->
  <script src="app.js" defer></script>

  <!-- INLINE FALLBACK: app.js yuklanmasa ham ishlaydi -->
  <script>
    (function () {
      const BASE_URL = "https://yashilmakon.eco/#/tree/";

      function wireUp() {
        const form = document.getElementById("treeForm");
        const input = document.getElementById("treeId");
        const error = document.getElementById("errorText");
        const btn = document.getElementById("submitBtn");

        if (!form || !input || !error || !btn) return;

        // agar app.js allaqachon ulab bo‘lsa, ikki marta ulab yubormaymiz
        if (form.dataset.bound === "1") return;
        form.dataset.bound = "1";

        const ua = (navigator.userAgent || "").toLowerCase();
        const isTelegram = ua.includes("telegram") || ua.includes("tgbrowser") || ua.includes("tg");

        function showError(msg) {
          error.textContent = msg;
          input.classList.add("input--bad");
          btn.disabled = false;
          try { input.focus(); } catch {}
        }

        function clearError() {
          error.textContent = "";
          input.classList.remove("input--bad");
        }

        input.addEventListener("input", () => {
          const cleaned = input.value.replace(/\D+/g, "");
          if (input.value !== cleaned) input.value = cleaned;
          clearError();
        });

        form.addEventListener("submit", (e) => {
          e.preventDefault();
          btn.disabled = true;
          clearError();

          const id = input.value.trim();
          if (!id) return showError("ID raqamini kiriting.");
          if (!/^\d+$/.test(id)) return showError("Maydonga faqat raqamlar kiritiladi.");

          const target = BASE_URL + encodeURIComponent(id);

          // Telegram’da popup bloklanadi -> shu oynada ochamiz
          if (isTelegram) {
            window.location.assign(target);
            return;
          }

          // boshqalarda yangi tab, bo‘lmasa fallback
          const win = window.open(target, "_blank", "noopener,noreferrer");
          if (!win) window.location.assign(target);

          // sahifa joyida qolsa (yangi tab ochilganda) inputni tozalaymiz
          input.value = "";
          btn.disabled = false;
        });

        // qaytib kelganda ham “disabled” bo‘lib qolmasin
        window.addEventListener("pageshow", () => { btn.disabled = false; });
        window.addEventListener("focus", () => { btn.disabled = false; });
      }

      // DOM tayyor bo‘lganda ulaymiz
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", wireUp);
      } else {
        wireUp();
      }
    })();
  </script>
</body>
</html>
